---
title: 'ADNI-NRM-NIGHTINGALE BASELINE'
date: "`r format(Sys.Date())`"
author: "Marco Fernandes (maff)"
output:
  html_document:
    theme: lumen
    number_sections: false
    font-family: Open Sans, sans-serif
    font-import: https://fonts.googleapis.com/css?family=Open+Sans
    #code_folding: show
    highlight: tango
editor_options: 
  chunk_output_type: console
---

<style type="text/css">
body{ /* Normal  */
      font-size: 14px;
  }
td {  /* Table  */
  font-size: 12px;
}
h1, .h1, h2, .h2, h3, .h3 {
    margin-top: 10.5px;
    margin-bottom: 10.5px;
}
h1.title {
  font-size: 28px;
  color: #7db956;
}
h1 { /* Header 1 */
  font-size: 28px;
  color: #3e4a52;
}
h2 { /* Header 2 */
    font-size: 18px;
  color: #3e4a52;
}
h3 { /* Header 3 */
  font-size: 14px;
  color: #3e4a52;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
th.sorting { /* DT column headers  */
    text-align: left;
}
.nav>li>a { /* Tabs  */
    color: #3e4a52;
    font-size: 14px;
    /* font-weight: bold; */
}
.nav-tabs>li.active>a, .nav-tabs>li.active>a:hover, .nav-tabs>li.active>a:focus {
    color: #7db956;}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
setwd("F:/data/PROJECTS/RIMA/Nightingale")

library(caret)
library(caretEnsemble)
require(doParallel)
library(DT)
library(knitr)

library(Biobase)
```



# Read-in {.tabset}

## expressionSet

```{r makeEset, message=FALSE, warning=FALSE}
input_df2Eset <- function (myfile) {
  `%notin%` <- Negate(`%in%`)
  sp.gene <- read.csv(file=paste0(getwd(),"/ADNIMERGE.csv"), 
                      header=TRUE, na.strings=c("NA"," ", "", ""))
  mx.gene <- read.csv(file=paste0(getwd(),"/ADNINIGHTINGALE_20180827.csv"), 
                      header=TRUE, na.strings=c("NA"," ", "", "NDEF"))
  rx <- read.csv(file=paste0(getwd(),"/ADMCPATIENTDRUGCLASSES_20170512-1.csv"), 
                 header=TRUE, na.strings=c("NA"," ", ""))
  ######################################
  rid.4993 <- subset(rx, RID == '4993')
  rx <- rbind(subset(rx, VISCODE2 == "bl"),rid.4993)
  rx <- cbind(RID = rx$RID, sapply(rx[, 4:ncol(rx)], function(x) ifelse(!is.na(x), 1, 0)))
  atc.rx <- read.csv(file=paste0(getwd(),"/rx_classes.csv"), 
                     header=TRUE, na.strings=c("NA"," ", ""))
  atc.rx <- rbind(c("RID","RID","RID","RID","RID"), atc.rx, c("NA.","NAS","NAS","NAS","NAS"))
  colnames(rx) <- atc.rx$ATC.name.major
  rx <- sapply(unique(colnames(rx)), 
                 function(x) rowSums( rx[ , grep(x, colnames(rx)), drop=FALSE]) )
  rx <- as.data.frame(rx)
  rx <- cbind(RID = rx$RID, sapply(rx[, 2:ncol(rx)], function(x) ifelse(x >= 1, 1,0)))
  rx <- rx[, -c(ncol(rx))]
  rx <- as.data.frame(rx)
  print(paste0("samples dim: ",dim(sp.gene)))
  print(paste0("metabolomic matrix dim: ",dim(mx.gene)))
  tagCount <- apply(mx.gene[, 5:12], 2, sum)
  print(paste0("remove tagged RID: ",sum(tagCount)))
  mx.gene <- mx.gene[rowSums(mx.gene[,5:12]) < 1, ]
  mx.gene <- mx.gene[, c(1,14:ncol(mx.gene)-1)]
  print(paste0("dups: ",table(duplicated(mx.gene$RID))[2]))
  mx.gene <- aggregate(mx.gene[, 2:ncol(mx.gene)], by=list(RID=mx.gene$RID), 
                       function(x) mean(as.numeric(as.character(x))))
  print(paste0("missing in ADNIMERGE metadata --> RID: ",mx.gene[which(mx.gene$RID %notin% sp.gene$RID),][1]))
  missInd <- mx.gene[which(mx.gene$RID %notin% sp.gene$RID),][1]
  mx.gene <- mx.gene[which(mx.gene$RID %notin% missInd$RID),]
  sp.gene <- sp.gene[which(sp.gene$RID %in% mx.gene$RID),]
  sp.gene <- subset(sp.gene, VISCODE == "bl")
  sp.gene <-  sp.gene[order(sp.gene$RID),]
  rx.gene <- rx[which(rx$RID %in% mx.gene$RID),]
  print(paste0("missing in Medication metadata --> RID: ",mx.gene[which(mx.gene$RID %notin% rx.gene$RID),][1]))
  ############################################                
  
  mx.gene <-  mx.gene[order(mx.gene$RID),]
  rx.gene <-  rx.gene[order(rx.gene$RID),]
  gene <- t(mx.gene)
  colnames(gene) <- gene[1, ]
  gene <- gene[c(2:nrow(gene)), ]
  colsData <- cbind(sp.gene[, c(1,3,4,6,9:15)], sp.gene[, grep("_bl$", colnames(sp.gene))], rx.gene[, -c(1)])
  row.names(colsData) <- colsData[, 1]
  colsData <- colsData[, -1]
  print(paste0("colnames(gene) == row.names(colsData): ", all(colnames(gene) == row.names(colsData))))
  phenoData <- new("AnnotatedDataFrame", data=colsData)
  eset <- ExpressionSet(assayData=as.matrix(gene), phenoData=phenoData)
  return(eset)
}

eset <- input_df2Eset(myfile)
print(eset)
saveRDS(eset, "./eset_met.rds")
```



# Description {.tabset}


## summary-stats-rid

```{r summaryStats}
sum_stats <- function(x) {
  c(min = round(min(x, na.rm = TRUE), digits = 2), mean = round(mean(x, na.rm = TRUE), digits = 2), sd = round(sd(x, na.rm = TRUE), digits = 2),
    max = round(max(x, na.rm = TRUE), digits = 2), n.nan = sum(is.na(x)), n.zeros = length(which(x==0)),
    n.nan.prop = ifelse(sum(is.na(x)) != 0, round((sum(is.na(x))/length(x))*100, digits = 2), 0), 
    zeros.prop = ifelse(length(which(x==0)) != 0, round((length(which(x==0))/length(x))*100, digits = 2), 0))
}

sumStats.rid <- as.data.frame(t(sapply(as.data.frame(exprs(eset)),sum_stats)))
sumStats.met <- as.data.frame(t(apply(as.data.frame(exprs(eset)),1, sum_stats)))

### RID

c.rid <- cbind(sumStats.rid,DX = eset$DX)
c.rid.sub <- subset(c.rid, c.rid$n.nan.prop <= 0)

library(DT)

create_dt <- function(x){
  DT::datatable(x,
                extensions = 'Buttons',
                options = list(dom = 'Blfrtip',
                               buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                               lengthMenu = list(c(10,25,50,-1),
                                                 c(10,25,50,"All"))))
}

create_dt(c.rid)
```


## summary-stats-met

```{r, table_MET}
library(DT)

create_dt <- function(x,y){
  DT::datatable(x,
                rownames = y,
                extensions = 'Buttons',
                options = list(dom = 'Blfrtip',
                               buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                               lengthMenu = list(c(10,25,50,-1),
                                                 c(10,25,50,"All"))))
}

create_dt(sumStats.met,y=TRUE)

```


## annotations-met

```{r, table_anno}
met.dic <- read.csv(file=paste0(getwd(),"/ADNINIGHTINGALE_DICT_20180827.csv"), 
                      header=TRUE, na.strings=c("NA"," ", "", "-4"))
met.dic <- met.dic[, c("FLDNAME", "TEXT", "UNITS")]


torm <- c("FLDNAME",
"VISCODE",
"VISCODE2",
"EXAMDATE",
"TAG_LOW_GLUCOSE",
"TAG_HIGH_PYRUVATE",
"TAG_HIGH_LACTATE",
"TAG_UNEXPECTED_AMINO_ACID_SIGNALS",
"TAG_LOW_GLUTAMINE_HIGH_GLUTAMATE",
"TAG_LOW_PROTEIN_CONTENT",
"TAG_PLASMA_SAMPLE",
"TAG_HIGH_ETHANOL")

`%notin%` <- Negate(`%in%`)
met.dic <- met.dic[which(met.dic$FLDNAME %notin% torm),]
met.dic_2 <- met.dic[!grepl(" in |Ratio of |Mean diameter |Estimated degree | total |Total ", met.dic$TEXT), ]
create_dt(met.dic,y=FALSE)
```


### preProcess: zero and near-zero-variance predictors
```{r, ml_caret}
library(caret)
library(caretEnsemble)
library(dplyr)
library(RANN)

mx.df <- data.frame(pData(eset), t(exprs(eset)))
# sel.cli.vars <- c("DX_bl", "AGE", "PTGENDER", "PTRACCAT", "PTEDUCAT", "CARDIOVASCULAR.SYSTEM", "NERVOUS.SYSTEM",
#               "GENITO.URINARY.SYSTEM.AND.SEX.HORMONES", "ALIMENTARY.TRACT.AND.METABOLISM", "RESPIRATORY.SYSTEM",
#               "DERMATOLOGICALS", "SYSTEMIC.HORMONAL.PREPARATIONS.EXCL.SEX.HORMONES.AND.INSULINS", "SENSORY.ORGANS",
#               "MUSCULO.SKELETAL.SYSTEM")
# sel.met.vars <- rownames(met.sel)
# sel.vars <- append(sel.cli.vars, sel.met.vars)
# 
# mx.df_sel <- mx.df[, sel.vars]
# 
# mx.df_sel$PTRACCAT <- gsub("More than one","Other", mx.df_sel$PTRACCAT)
# mx.df_sel$PTRACCAT <- gsub("Am Indian/Alaskan","Other", mx.df_sel$PTRACCAT)
# mx.df_sel$PTRACCAT <- gsub("Hawaiian/Other PI","Other", mx.df_sel$PTRACCAT)
# mx.df_sel$PTRACCAT <- gsub("Unknown","Other", mx.df_sel$PTRACCAT)
# 
# nzv.dat <- nearZeroVar(mx.df_sel, saveMetrics= TRUE)
# nzv.f <- nzv.dat[nzv.dat$nzv, ]
# 
# nzv.f %>%
#   DT::datatable() %>%
#   formatRound(columns=c("freqRatio", "percentUnique"), digits=3)
# 
# nzv <- nearZeroVar(mx.df_sel)
# mx.df_filt <- mx.df_sel[, -nzv]
```

## correlation plot

```{r corrPlot, fig.width=5, fig.height=5, fig.cap="Spearman correlations. Pvalue < 0.01."}

require(ggpubr)
require(tidyverse)
require(Hmisc)
require(corrplot)

# mx.df %>%
#   dplyr::select(is.numeric) %>%
#   apply(2, sum_stats) %>%
#   t() %>%
#   View()

cor.df.sub <- mx.df %>%
  dplyr::select(is.numeric) %>%
    # select(-c("PIB_bl","DIGITSCOR_bl", "Month_bl", "Years_bl", "CARDIOVASCULAR.SYSTEM", "NERVOUS.SYSTEM",
    #           "GENITO.URINARY.SYSTEM.AND.SEX.HORMONES", "ALIMENTARY.TRACT.AND.METABOLISM", "RESPIRATORY.SYSTEM",
    #           "DERMATOLOGICALS", "SYSTEMIC.HORMONAL.PREPARATIONS.EXCL.SEX.HORMONES.AND.INSULINS", "SENSORY.ORGANS",
    #           "MUSCULO.SKELETAL.SYSTEM", "SITE")) %>%
      select(c("AGE", "PTEDUCAT", "MMSE_bl", "ADAS13_bl", "Ventricles_bl", 
               "Entorhinal_bl", "PHE", "PUFA", "SERUM_C", "APOB_APOA1")) %>%
  na.omit() %>%
  as.matrix() %>%
  rcorr(type = "spearman")

cor.mx <- data.frame(cor = cor.df.sub$r, pvalue = cor.df.sub$P)
corrplot(cor.df.sub$r, type = "lower", 
         p.mat = cor.df.sub$P, sig.level = 0.05, 
         insig = "blank", order="hclust", 
         outline = TRUE, addrect=3, tl.cex=0.5,
         tl.col="blue", tl.srt=45)
```



## correlation pairwise

```{r corrTable}
# library(rstatix)
# 
# a <- mx.df %>%
#   dplyr::select(is.numeric) %>%
#     select(-c("PIB_bl","DIGITSCOR_bl", "Month_bl", "Years_bl", "CARDIOVASCULAR.SYSTEM", "NERVOUS.SYSTEM",
#               "GENITO.URINARY.SYSTEM.AND.SEX.HORMONES", "ALIMENTARY.TRACT.AND.METABOLISM", "RESPIRATORY.SYSTEM",
#               "DERMATOLOGICALS", "SYSTEMIC.HORMONAL.PREPARATIONS.EXCL.SEX.HORMONES.AND.INSULINS", "SENSORY.ORGANS",
#               "MUSCULO.SKELETAL.SYSTEM", "SITE")) %>%
#   na.omit() %>%
#   cor_mat() %>%
#   cor_gather()
# 
# b <- a[!duplicated(t(apply(a, 1, sort))), ]
# b %>%
#   subset(cor < 1) %>%
#    DT::datatable(
#                 extensions = 'Buttons',
#                 options = list(dom = 'Blfrtip',
#                                buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
#                                lengthMenu = list(c(10,25,50,-1),
#                                                  c(10,25,50,"All"))),
#                 caption = htmltools::tags$caption("Spearman pairwise correlations. Correlation coefficient (cor), pvalue (p).")) %>%
#    DT::formatSignif(columns = c("cor", "p"), digits = 3)
```


```{r flatCorrMatrix}
library(tidyr)
library(tibble)

cor.df <- mx.df %>%
  dplyr::select(is.numeric) %>%
    select(-c("PIB_bl","DIGITSCOR_bl", "Month_bl", "Years_bl", "CARDIOVASCULAR.SYSTEM", "NERVOUS.SYSTEM",
               "GENITO.URINARY.SYSTEM.AND.SEX.HORMONES", "ALIMENTARY.TRACT.AND.METABOLISM", "RESPIRATORY.SYSTEM",
             "DERMATOLOGICALS", "SYSTEMIC.HORMONAL.PREPARATIONS.EXCL.SEX.HORMONES.AND.INSULINS", "SENSORY.ORGANS",
               "MUSCULO.SKELETAL.SYSTEM", "SITE")) %>%
      #select(c("AGE", "PTEDUCAT", "MMSE_bl", "ADAS13_bl", "Ventricles_bl", 
               #"Entorhinal_bl", "PHE", "PUFA", "SERUM_C", "APOB_APOA1")) %>%
  na.omit() %>%
  as.matrix() %>%
  rcorr(type = "spearman")

flat_cor_mat <- function(cor_r, cor_p){
  cor_r <- rownames_to_column(as.data.frame(cor_r), var = "row")
  cor_r <- gather(cor_r, column, cor, -1)
  cor_p <- rownames_to_column(as.data.frame(cor_p), var = "row")
  cor_p <- gather(cor_p, column, p, -1)
  cor_p_matrix <- left_join(cor_r, cor_p, by = c("row", "column"))
  cor_p_matrix
}

cor_matrix <- flat_cor_mat(cor.df$r, cor.df$P)
b <- cor_matrix[!duplicated(t(apply(cor_matrix, 1, sort))), ]
b %>%
  subset(p < 0.05) %>%
  subset(cor < 0.9999) %>%
   DT::datatable(
                extensions = 'Buttons',
                options = list(dom = 'Blfrtip',
                               buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                               lengthMenu = list(c(10,25,50,-1),
                                                 c(10,25,50,"All"))),
                caption = htmltools::tags$caption("Spearman pairwise correlations. Correlation coefficient (cor), pvalue (p).")) %>%
   DT::formatSignif(columns = c("cor", "p"), digits = 3)
```


# Unsupervised multi-ML {.tabset}


## Clustering

```{r}
library(diceR)
obj <- dice(imputed_mx, nk = 2:6, reps = 3, algorithms = c("km", "diana"),
            cons.funs = c("kmodes", "majority"), plot=FALSE)

knitr::kable(obj$indices$ii$`4`)

CC1 <- consensus_cluster(imputed_mx, nk = 2:6, reps = 3,
algorithms = c("diana", "km"), progress = FALSE)
p1 <- graph_cdf(CC1)
p1 + theme_bw()

cc1_eval <- consensus_evaluate(x, CC, ref.cl = ref.cl, n = 1, trim = TRUE)
```


```{r, message=FALSE, warning=FALSE, echo=FALSE}
set.seed(1)
pam_4 <- obj$clusters[,"majority"]
sig_obj <- sigclust(X, k = 2, nsim = 100, labflag = 0, label = pam_4)
co <- capture.output(str(sig_obj))
strwrap(co, width = 80)
```


```{r}
# data(hgsc)
# hgsc <- hgsc[1:100, 1:50]
# # 
# CC <- consensus_cluster(hgsc, nk = 3:4, p.item = 0.8, reps = 5,
#                         algorithms = c("hc", "pam", "diana"))
# # 
# CC <- apply(CC, 2:4, impute_knn, data = hgsc, seed = 1)
# CC_imputed <- impute_missing(CC, hgsc, nk = 4)
# # 
# pam.4 <- CC[, , "PAM_Euclidean", "4", drop = FALSE]
# cm <- consensus_matrix(pam.4)
# # 
# hm <- graph_heatmap(pam.4)
# 
# ccomb_matrix <- consensus_combine(CC, element = "matrix")
# ccomb_class <- consensus_combine(CC, element = "class")
# 
# # consensus matrix across subsamples and algorithms within k = 3
# cm_k3 <- consensus_matrix(ccomb_class$`3`)
# 
# # consensus matrix across subsamples and algorithms within k = 4
# cm_k4 <- consensus_matrix(ccomb_class$`4`)
# 
# # consensus matrix across subsamples and algorithms and k
# cm_all <- consensus_matrix(ccomb_class)
# 
# CC2 <- consensus_cluster(hgsc, nk = 3:4, p.item = 0.8, reps = 5,
#                          algorithms = "km")
# ccomb_class2 <- consensus_combine(CC, CC2, element = "class")
# 
# ccomp <- consensus_evaluate(hgsc, CC, CC2, plot = FALSE)
# 
# ctrim <- consensus_evaluate(hgsc, CC, CC2, trim = TRUE, reweigh = FALSE, n = 2)
# 
# set.seed(1)
# pam_4 <- ccomb_class2$`4`[, "PAM_Euclidean"]
# sig_obj <- sigclust::sigclust(hgsc, nsim = 100, labflag = 1, label = pam_4)
```



# Supervised multi-ML {.tabset}

## preProcess: k-NN imputation

```{r, imputation}
library(caret)

mydf <- cbind.data.frame(DX = mx.df[, 11], mx.df[, 4:6], mx.df[, 59:ncol(mx.df)])
mydf$PTGENDER <- ifelse(mydf$PTGENDER == "Male", 1, 0)

`%notin%` <- Negate(`%in%`)

mydf <- mydf[which(mydf$DX %notin% c("SMC")),]

mydf_1 <- mydf[, -1]

set.seed(12345)
imput.met <- preProcess(mydf_1,
                           method = "knnImpute",
                           k = round(sqrt(ncol(mydf_1)), digits = 0),
                           knnSummary = mean
  
)

imputed_mx <- predict(imput.met, mydf_1)
anyNA(imputed_mx)

imputed_mx_1 <- cbind.data.frame(DX = mydf[, 1], imputed_mx)

nzv <- nearZeroVar(imputed_mx_1)
imputed_mx_1 <- imputed_mx_1[, -nzv]
```


```{r}
set.seed(998)
inTraining <- createDataPartition(imputed_mx_1$DX, p = .80, list = FALSE)
training <- imputed_mx_1[inTraining,]
testing  <- imputed_mx_1[-inTraining,]

anyNA(training)
anyNA(testing)


```


```{r multiMLcaret, cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}

set.seed(1)
my_control <- trainControl(method = "cv",
                       savePredictions = "final",
                       index = createMultiFolds(training$DX, k = 10, times = 3),
                       classProbs = TRUE,
                       summaryFunction = multiClassSummary,
                       allowParallel = TRUE)

cl <- makeCluster(detectCores())
registerDoParallel(cl)
set.seed(1)
model_list <- caretList(DX ~ ., data = training,
                        trControl = my_control,
                        methodList = c("knn", "rf", "svmRadial", "pls", "glmnet", "gbm"),
                        tuneList = NULL,
                        continue_on_fail = FALSE)
                      
stopCluster(cl)

saveRDS(model_list, "./caret_modelList.rds")
```


## ML Accuracy comparison

```{r, fig.width=5, fig.height=5}
resamples <- resamples(model_list)
dotplot(resamples, metric = "Accuracy")
```

```{r}
#summary(resamples)
```

## ML models correlation

```{r}
modelCor(resamples) %>%
   DT::datatable() %>%
   DT::formatSignif(columns = colnames(modelCor(resamples)), digits = 2)
```

## ML comparison metrics

```{r, fig.width=14, fig.height=14}
scales <- list(x=list(relation="free"), y=list(relation="free"))
bwplot(resamples, scales=scales)
```


```{r}
pred_glmnet <- predict.train(model_list$glmnet, newdata = testing)
```



## confusion matrix

```{r confusionMatrix}
library(ggplot2)
library(dplyr)

testing$DX <- as.factor(testing$DX)
pred_glmnet <- as.factor(pred_glmnet)

details <- confusionMatrix(reference = testing$DX, data = pred_glmnet, mode='everything')
table <- data.frame(confusionMatrix(reference = testing$DX, data = pred_glmnet, mode='everything')$table)

plotTable <- table %>%
  mutate(goodbad = ifelse(table$Prediction == table$Reference, "good", "bad")) %>%
  group_by(Reference) %>%
  mutate(prop = Freq/sum(Freq))

detailsTable <- t(as.data.frame(details$byClass))
detailsTable.1 <- as.data.frame(t(detailsTable[, -c(3:4, 8:11)]))
#########################################################
detailsOvera <- t(as.data.frame(details$overall))
detailsOvera1 <- as.data.frame(t(detailsOvera[, -c(3:7)]))

metrics = cbind(detailsTable.1, detailsOvera1)
metrics <- as.data.frame(lapply(metrics, function(x) if(is.numeric(x)) format(round(x, 3), nsmall = 3) else x))
#########################################################

par(mar=c(2,2,2,2))
library(ggpmisc)

black.11.text <- element_text(face = "bold", color = "black", size = 11)

p1 <- ggplot(data = plotTable, mapping = aes(x = Reference, y = Prediction, fill = goodbad, alpha = Freq)) +
              geom_tile() +
                geom_text(aes(label = Freq), vjust = .5, fontface  = "bold", alpha = 1) +
                scale_fill_manual(values = c(good = "orange", bad = "dodgerblue3")) + theme_bw() +
                xlim(rev(levels(table$Reference)))

p1 + ggtitle("Confusion Matrix and Statistics") + theme(
plot.title = element_text(color="blue", size=14, face="bold", hjust = 0.5),
axis.title.x = element_text(color="blue", size=12, face="bold"),
axis.title.y = element_text(color="blue", size=12, face="bold"),
axis.text.x = black.11.text,
axis.text.y = black.11.text,
legend.title = black.11.text,
panel.grid.major = element_blank()
)
```


```{r}
library(gridExtra)
library(grid)
tt1 <- ttheme_minimal()

met.ove <- as.data.frame(t(data.frame(metrics = details$overall)))
met.ove %>%
  dplyr::select(c(-5,-6,-7)) %>%
  round(3) %>%
grid.table(theme=tt1)
```



## variable-importance

```{r, variable-importance}
glmnetImp <- varImp(model_list$glmnet, scale = FALSE)
plot(glmnetImp, top = 4)
```



```{r, echo=FALSE}
# library(ggplot2)
# library(scales)
# 
# varimp_rf <- varImp(model_rf)
# ggplot(varimp_rf, main="Variable Importance with RF")
# 
# varimp_rf <- as.data.frame(knnImp$importance)
# varimp_rf$varnames <- rownames(varimp_rf)
# rownames(varimp_rf) <- NULL
# 
# theme_set(theme_classic())
# varimp_rf$varnames <- factor(varimp_rf$varnames, levels = varimp_rf$varnames)
# # Plot ###################################################################################
# varimp_rf %>%
#   top_n(20, Overall) %>%
# ggplot(aes(x=reorder(varnames, Overall), y=Overall)) + 
#   geom_point(col="red", size=4) +   # Draw points
#   geom_segment(aes(x=varnames, 
#                    xend=varnames, 
#                    y=min(Overall), 
#                    yend=max(Overall)), 
#                linetype="dashed", 
#                size=0.1) +   # Draw dashed lines
#   geom_point(col="red", size=4) +   # Draw points
#   labs(title="Metabolite Importance", 
#        subtitle="RF: variable importance",
#        caption="maff") + labs(x = "metabolite", y = "overall importance") + 
#   coord_flip() +
# theme(
# plot.title = element_text(color="blue", size=14, face="bold", hjust = 0.5),
# plot.subtitle = element_text(hjust = 0.5),
# axis.title.x = element_text(color="blue", size=12, face="bold"),
# axis.title.y = element_text(color="blue", size=12, face="bold"),
# axis.text.x = black.11.text,
# axis.text.y = element_text(color="black", size=11),
# legend.title = black.11.text,
# panel.grid.major = element_blank()
# )
```